<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  <script src="//ops-proxy-demo.winify.com/assets/javascripts/jquery-2.1.0.min.js"></script>
  <script src="//ops-proxy-demo.winify.com/assets/javascripts/cleave.min.js"></script>
  <script src="//ops-proxy-demo.winify.com/assets/javascripts/v2/utils-ocr.js"></script>
  <script src="//ops-proxy-demo.winify.com/assets/javascripts/v2/muume.js"></script>
  <script src="//ops-proxy-demo.winify.com/assets/javascripts/v2/ops.js"></script>
  <script src="//ops-proxy-demo.winify.com/assets/javascripts/v2/payment-ocr.js"></script>
  <script src="//ops-proxy-demo.winify.com/assets/javascripts/v2/ocr.js"></script>
  <script>
    if ((/iPhone|iPod|iPad|Android|BlackBerry/).test(navigator.userAgent) == true) {
      $(document).ready(function () { $('html').addClass('mobile') })
    }
    $(document).ready(function () {
      if (!$('html').hasClass('mobile')) {
        var bodyHeight = $('body').height()
        $(window).on('resize', function () {
          $('body').css('height', 'auto')
          $('body').css('width', 'auto')
        }).trigger('resize')
      }
      var ua = navigator.userAgent
      if (ua.indexOf('Android') >= 0) {
        var androidversion = parseFloat(ua.slice(ua.indexOf('Android') + 8))
        if (androidversion < 5.0) {
          $('#openCamera span').text('Your device does not support this feature')
          $('#openCamera').show()
        }
      }
      var scaleFactor = 8
      var video = document.getElementById('video')
      var canvas = document.getElementById('canvas')
      var context = canvas.getContext('2d')
      var rotateValue = 1
      $('#takenPicture').click(function () { $('#takenPicture').css('transform', 'rotate(' + ((rotateValue++ % 4) * 90) + 'deg)') })
      $('#expiration_month_year').on('change input', function () {
        var val = $('#expiration_month_year').val()
        var month = val.substring(0, 2)
        var year = '20' + val.substring(3, 5)
        $('#expiration_month').val(month)
        $('#expiration_year').val(year)
      })
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        console.log('window.inner' + window.innerWidth + ' ' + window.innerHeight)
        navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}}).then(function (stream) {
          video.srcObject = stream
          video.play()
          video.onloadedmetadata = function () {
            context.canvas.width = $('#video').width()
            context.canvas.height = $('#video').height()
          }
        }).catch(function (err) { alert('Error ' + err + ', User agent: ' + navigator.userAgent) })
        $('#scanAgain').click(function () {
          $('#alert').html()
          $('#videoWrapper').show()
          $('#takeAPicture').show()
          $('#scanAgain').hide()
          $('#registrationCardBtn').hide()
          $('#previewPicture').hide()
        })
        $('#takeAPicture').click(function () {
          var video = document.getElementById('video')
          context.drawImage(video, 0, 0, $('#video').width(), $('#video').height())
          var dataUrl = canvas.toDataURL('image/jpeg', 0.5)
          var dataBlob = dataURItoBlob(dataUrl)
          var formData = new FormData()
          formData.append('file', dataBlob, 'cc.jpg')
          $('#takenPicture').css('background-image', 'url("' + dataUrl + '")')
          $('#previewPicture').hide()
          $('#ocrLoader').show()
          $('#ocrInProgressMessage').show()
          $.ajax({
            type: 'POST',
            url: OCR_SERVER_URL,
            contentType: false,
            processData: false,
            data: formData,
            success: function (result) {
              $('#takenPicture').css('width', $('#video').width()).css('height', $('#video').height()).css('background-position', '0px 0px')
              $('#takeAPicture').hide()
              $('#scanAgain').show()
              if (result.result == '') {
                $('#alert').html('Image could not be recognized, try again')
                $('#alert').show()
              } else {
                $('#alert').hide()
                var cardData = parseReturnedOcrData(result)
                if (fillForm(cardData) == false) { $('#alert').show() } else { $('#takenPicture').css('width', cardData['position_width'] + 'px').css('height', cardData['position_height'] + 'px').css('background-position', '-' + cardData['position_x'] + 'px ' + '-' + cardData['position_y'] + 'px') }
              }
            },
            error: function (result) { $('#alert').html('Error occured! Please try again later.').show() },
            complete: function () {
              $('#videoWrapper').hide()
              $('#previewPicture').show()
              $('#registrationCardBtn').show()
              $('#ocrInProgressMessage').hide()
              $('#ocrDoneMessage').show()
              setTimeout(function () {
                $('#ocrLoader').hide()
                window.scrollTo(0, document.body.scrollHeight)
              }, 2000)
            }
          })
        })
      } else {
        $('#openCamera').show()
        $('#scanAgain').show()
        $('#registrationCardBtn').show()
        $('#takeAPicture').hide()
        $('#videoWrapper').hide()
        $('#scanAgain').click(function () { $('#data').click() })
        $('#openCamera').click(function () {
          $('#data').click()
          $(this).hide()
        })
        $('#data').change(function () { readURL(this) })
        $('#sendOCR').click(function (e) {
          e.preventDefault()
          if (!$('#data').val()) {
            alert('Take a picture first')
            return
          }
          var form = $('#ocrForm')[0]
          var formData = new FormData(form)
          $('#previewPicture').hide()
          $('#ocrLoader').show()
          $('#ocrInProgressMessage').show()
          $('#ocrDoneMessage').hide()
          $('#alert').hide()
          $.ajax({
            type: 'POST',
            url: OCR_SERVER_URL,
            contentType: false,
            processData: false,
            data: formData,
            success: function (result) {
              if (result.result == '') {
                $('#alert').html('Image could not be recognized, try again')
                $('#alert').show()
              } else {
                cardData = parseReturnedOcrData(result)
                if (fillForm(cardData) == false) { $('#alert').show() } else {
                  $('#takenPicture').css('width', cardData['position_width'] + 'px')
                  $('#takenPicture').css('height', cardData['position_height'] + 'px')
                  $('#takenPicture').css('background-position', '-' + cardData['position_x'] + 'px ' + '-' + cardData['position_y'] + 'px')
                  $('#takenPicture').css('background-repeat', 'no-repeat')
                  countRotation(result.creditCardCoordinate[0])
                }
              }
            },
            error: function (result) { $('#alert').html('Error occured! Please try again later.').show() },
            complete: function () {
              $('#previewPicture').show()
              $('#ocrInProgressMessage').hide()
              $('#ocrDoneMessage').show()
              setTimeout(function () {
                $('#ocrLoader').hide()
                window.scrollTo(0, document.body.scrollHeight)
              }, 2000)
            }
          })
        })
      }
    })
  </script>
</head>
<body>
<div id="blur">
  <div id="loader">
    <img src="//ops-proxy-demo.winify.com/assets/graphics/loader_fast.gif" />
  </div>
</div>
<div class="ocr-wv-camera-area">
  <div id="openCamera">
    <span>Click to open camera</span>
  </div>
  <div id="ocrLoader">
    <span id="ocrInProgressMessage">Please wait... image recognition in progress
        <br />
        <img src="//ops-proxy-demo.winify.com/assets/graphics/ajaxLoader.gif">
    </span>
    <span id="ocrDoneMessage">DONE! Check your data with picture!</span>
  </div>
  <form id="ocrForm">
    <input type="file" id="data" name="file" accept="image/*;capture=camera" required capture >
    <button id="sendOCR" type="submit"></button>
  </form>
  <div id="videoWrapper">
    <video id="video" autoplay playsinline></video>
  </div>
  <canvas id="canvas" style="display: none;"></canvas>
  <div id="previewPicture">
    <span id="takenPicture" />
  </div>
</div>
<div class="ocr-wv-form-area">
  <form id="paymentForm" method="post" action="payment">
    <fieldset>
      <input type="hidden" id="ses_id" name="ses_id" value="aea9076997a74efd93e4abde5aacd82f">
      <input type="hidden" id="language" name="language" value="en">
      <div id="alert"></div>
      <div class="ocr-wv-form-card-number">
        <label>Card number</label>
        <!-- Card number -->
        <div id="brand_logo">
          <input type="radio" value="VISA" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/visa_logo.png" alt="">
          <input type="radio" value="MASTER" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/master_logo.png" alt="">
          <input type="radio" value="AMEX" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/amex_logo.png" alt="">
          <input type="radio" value="DINERS" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/diners_logo.png" alt="">
          <input type="radio" value="DISCOVER" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/discover_logo.png" alt="">
          <input type="radio" value="JCB" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/jcb_logo.png" alt="">
          <input type="radio" value="UNIONPAY" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/unionpay_logo.png" alt="">
          <input type="radio" value="MAESTRO" name="card_type">
          <img src="//ops-proxy-demo.winify.com/assets/graphics/cc_brands/maestro_logo.png" alt="">
        </div>
        <input id="card_number" name="card_number" type="tel" class="shadow" value="" />
      </div>
      <div class="ocr-wv-form-expiry-date">
        <label>Expiry date</label>
        <div id="expiryMonthYear_div">
          <input type="tel" id="expiration_month_year" name="expiration_month_year" class="shadow" />
          <input type="hidden" id="expiration_month" name="expiration_month" />
          <input type="hidden" id="expiration_year" name="expiration_year" />
        </div>
      </div>
      <div class="ocr-wv-form-cvv">
        <label>CVV</label>
        <input id="card_secure_code" name="card_secure_code" type="tel" class="shadow" value="">
      </div>
      <div class="ocr-wv-form-card-holder">
        <label>Name on card</label>
        <input id="card_holder" name="card_holder" type="text" class="shadow" value="">
      </div>
      <div id="tc" style="display: none;">
        <input type="checkbox" id="tc-muume" checked="">        I accept the
        <a href="https://muume.com/en/data-protection">Privacy Policy</a> and
        <a href="https://muume.com/en/agb-muume/">T&amp;C</a>
      </div>
      <div class="ocr-wv-form-buttons">
        <input type="button" id="takeAPicture" value="" />
        <input type="button" id="scanAgain" value="Scan again" style="display: none" />
        <input type="button" id="registrationCardBtn" name="submitBtn" value="Save card" style="display: none" />
      </div>
    </fieldset>
  </form>
</div>
<script>
  (function ($) {
    nativeCameraPrepareView();
    $('#takeAPicture')
      .add($('#openCamera'))
      .click(function () {
        nativeCameraInProgress();
        setTimeout(function () {
          nativeCameraOcrProcessDone()
        }, 2000)
      })

    function nativeCameraPrepareView() {
      $('#openCamera').show();
      $('#takeAPicture').show();
      $('#videoWrapper').hide();
      $('#scanAgain').hide();
      $('#registrationCardBtn').hide();
      $('#ocrDoneMessage').hide();
    }

    function nativeCameraInProgress() {
      $('#openCamera').hide();
      $('#previewPicture').show();
      $('#ocrLoader').show();
      $('#ocrDoneMessage').hide();
      $('#ocrInProgressMessage').show();
      $('#alert').hide();
    }

    function nativeCameraOcrProcessDone() {
      $('#takeAPicture').hide();
      $('#scanAgain').show();
      $('#registrationCardBtn').show();
      $('#ocrInProgressMessage').hide();
      $('#ocrDoneMessage').show();
    }
  })(jQuery)
</script>
</body>
</html>
